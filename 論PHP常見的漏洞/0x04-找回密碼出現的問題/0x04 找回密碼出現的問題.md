## **0x04 找回密碼出現的問題。**

<pre>
下面介紹一些我在cms遇到的找回密碼時候犯得錯誤。
找回密碼很多都是驗證的token 就是在找回密碼的時候生成一個token 然後存儲到數據庫中。然後把找回密碼的地址發到郵箱中 url中就含有token 由用戶點開後就能修改密碼 基本就是驗證的這個token。其實一般的可以找回任意用戶密碼的原因就是弱token 導致可以被攻擊者搞到。包括很多廠商驗證的時候就是四位純數字啥的。可以枚舉。當然也可以延伸一下, 一些cms的密碼加密方式很難破掉。有時候我們拿到了管理的密碼破不掉也是雞肋。所以有時候也可以利用這種方法 一般找回密碼是用的郵箱 首先我們可以注入把管理的郵箱注入出來 然後再去找回密碼 再把數據庫的token注入出來 再構造一下地址 就能重置密碼。這個給我印像比較深的是 在ssctf的比賽中嘛 當時機油問了問我 那wordpress那題 有個插件的注入 然後因為都知道wp的加密基本很難破。所以也是用的這種方法。因為一般都是弱token的問題 隨便找幾個例子了
</pre>

---

## **rand 函數生成的token**


```php
$resetpwd = md5(rand());
```
<pre>
可以看到這個生成的token 就是對rand()函數生成出來的數字進行md5一次
來看一下rand()
註釋：在某些平台下（例如 Windows）RAND_MAX 只有 32768。如果需要的範圍大於 32768，那麼指定 min 和 max 參數就可以生成大於 RAND_MAX 的數了，或者考慮用 mt_rand() 來替代它。如果不指定一些參數的話 那麼最大值才32768 一個並不算大的值 那麼我們首先對這32768種可能 md5出來一個列表 然後我們直接枚舉這32768種可能 總會有一個對的。
</pre>


---

## **修改hdwiki任意用戶密碼**

```php
$encryptstring=md5($this->time.$verification.$auth);
```

補丁後多了一個
```php
$auth$timetemp=date("Ymd H:i:s",$this->time);$auth = util::strcode($timetemp, 'ENCODE'); 
```
<pre>
可以$auch 是對時間來了一個算法。結果這個算法的KEY並沒有初始化 導致瞭如果我們知道了這個時間 就可以自己生成出來加密的字符串 這裡帶入算法的是時間 這裡是我們可以知道的。
</pre>

