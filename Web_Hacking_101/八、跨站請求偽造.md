## **八、跨站請求偽造**

>作者：Peter Yaworski
>
>譯者：飛龍
>
>協議：CC BY-NC-SA 4.0


## **描述**

跨站請求偽造，或CSRF攻擊，在惡意網站，電子郵件，即使消息，應用以及其它，使用戶的Web瀏覽器執行其它站點上的一些操作，並且用戶已經授權或登錄了該站點時發生。通常會在用戶不知道操作已經執行的情況下發生。

CSRF 攻擊的影響取決於收到操作的站點。這裡是一個例子：
1. Bob 登錄了它的銀行賬戶，執行了一些操作，但是沒有登出。
2. Bob 檢查了它的郵箱，並點擊了一個陌生站點的鏈接。
3. 陌生站點向 Bob 銀行站點發送請求來進行轉賬，並傳遞第一步中，保存 Bob 銀行會話的 Cookie 信息。
Bob 的銀行站點收到了來自陌生（惡意）站點的請求，沒有使用 CSRF Token 的情況下處理了轉賬。

更有意思的是這個想法，也就是惡意網站的鏈接可以包含有效的 HTML，`<imgsrc="www.malicious_site.com">`，並且並不需要 Bob 點擊鏈接。如果 Bob 的設備（例如瀏覽器）渲染了這個圖片，它會向`malicious_site.com`發送請求，來完成 CSRF 攻擊。
<p>
現在，知道了 CSRF 的危險之後，它們可以以多種方式防範。最流行的方式大概是 CSRF Token，它必須隨著潛在的數據修改氣你去一起提交（例如 POST 請求）。這裡，Web 應用（例如 Bob 的銀行）會生成一個兩部分的 Token，一個 Bob 會收到，另一個由應用保管。
<p>
當 Bob 試圖提交轉賬請求時，它就需要提交 Token，銀行會驗證它這一邊的 Token。
<p>
現在，對於 CSRF 和 CSRF Token 來說，跨域資源共享似乎越來越普遍了。或者只是我注意到是這樣。
本質上，CORS 限制了資源，包括 JSON 響應，被外域訪問。換句話說，當 CORS 用於保護站點時，你就不能編寫 JavaScript 來調用目標應用，讀取響應或者進行另一個調用，除非目標站點允許。
<p>

似乎這非常令人混亂，使用 JavaScript，嘗試調用`HackerOne.com/activity.json`，讀取響應並進行二次調用。你也會在下面的例子 #3 看到它的重要性，以及潛在的原理。

<p>

最後，重要的是要記住（感謝 Jobert Abma 補充），並不是每個不帶有 CSRF Token 的請求都帶有 CSRF 問題。一些站點可能執行額外的檢查，例如比較 Referer 協議頭（雖然可能出錯，並且有一些繞過它的案例）。它是一個字段，標識了鏈接到被請求資源的頁面地址。換句話說，如果 POST 調用中的 Referer 並不來源於收到 HTTP 請求的相同站點，站點可能不允許該調用，因此能夠完成和驗證 CSRF Token 的相同操作。此外，不是每個站點在創建或者定義 Token 時都使用csrf術語。例如，在 Badoo 它使用rt參數，我們下面會討論。

>連結
>
>[查看OWASP 測試指南。](https://www.owasp.org/index.php/Testing_for_CSRF_%28OTG-SESS-005%29)