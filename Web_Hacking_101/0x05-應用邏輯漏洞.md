## **九、應用邏輯漏洞**

>作者：Peter Yaworski
>
>譯者：飛龍
>
>協議：CC BY-NC-SA 4.0
>

應用邏輯漏洞不同於其他我們討論過的類型。雖然 HTML 注入、HTML 參數污染和 XSS 都涉及到提交一些類型的潛在惡意輸入，應用落地及漏洞實際上涉及到操縱場景和利用 Web APP 程式碼中的 Bug。
<p>

這一類型攻擊的一個值得注意的例子是 Egor Homakov 對 Github 的滲透，Github 使用 RoR 編寫。如果你不熟悉 Rails，他是一個非常流行的 Web 框架，在開發 Web 站點時，它可以處理很多繁雜的東西。

<p>

在2012 年3 月，Egor 通知了Rails 社區，通常，Rails 會接受所有提交給它的參數，並使用這些值來更新資料庫記錄（取決於開發者的實現。Rails 核心開發者的想法是，使用Rails的Web 開發者應該負責填補它們的安全間隙，並定義那個值能夠由用戶提交來更新記錄。這個行為已經在社區內人人皆知了，但是Github 上的線程展示了很少的人能夠鑑別出來它帶來的風險（[https://github.com/rails/rails/issues/5228](https://github.com/rails/rails/issues/5228)）。

當核心開發者不同意他的時候，Egor 繼續利用Github 上的認證漏洞，通過猜測和提交參數值，它包含創建日期（如果你熟悉Rails 並且知道多數資料庫記錄包含創建和更新日期列，它就不太困難）。因此，它在 Github 上傳了一個票據，年份是未來的某個日期。它也設法更新 SHH 訪問密鑰，這可以使他訪問 Github 官方的程式碼倉庫

<p>

之前提到了，這個滲透通過 Github 後端程式碼實現，它並沒有合理驗證 Egor 所做的事情，這在隨後可用於更新資料庫記錄。這裡，Egor 發現了叫做大量賦值漏洞的東西。


<p>

應用邏輯漏洞，即發現前面討論的這種類型的攻擊，更加有技巧性，因為它們依賴程式碼判定的創造性思維，並且並不僅僅是提交潛在的惡意程式碼，開發者沒有轉義它。 （不要嘗試在這裡簡化其它類型的漏洞，一些 XSS 攻擊也很複雜！）

<p>

使用 Github 的例子，Egor 知道了系統基於 Rails 以及 Rails 如何處理用戶輸入。在其他例子中，它涉及直接編程呼叫 API 來測試應用的行為，就像 Shopify 的管理員權限繞過那樣。或者，它涉及重複使用來自認證 API 呼叫的返回值，來進行後續的API 呼叫，本不應該允許你這麼做。


---

## **示例**

## **1. Shopify 管理員權限繞過**

```
難度：低

URL：shop.myshopify.com/admin/mobile_devices.json
報告鏈接：https://hackerone.com/reports/100938
報告日期：2015.11.22
獎金：$500
```

## **描述**

Shopify 是一個巨大並健壯的平台，它包含 Web UI 以及受支持的 API。這個例子中，API 不驗證一些權限，而 Web UI 明顯會這麼做。因此，商店的管理員，它們不被允許接受郵件提醒，可以通過操作 API 終端來繞過這個安全設置，在它們的 Apple 設備中收到提醒。

根據報告，黑客只需要：
- 使用完全訪問權限的帳號登錄 Shopify 移動應用
- 攔截`POST /admin/mobile_devices.json`的請求
- 移除該帳號的所有權限
- 移除新增的移動端提醒
- 重放`POST /admin/mobile_devices.json`的請求

這樣做之後，用戶可以接收到所有商店處的訂單的移動端提醒，因此忽略了商店配置的安全設置。


>重要結論
>
>這裡有兩個重要結論。首先，並不是所有東西都涉及程式碼注入。始終記住使用程式碼並觀察向站點傳遞了什麼資訊，
>並玩玩它看看什麼會發生。這裡，所有發生>的事情是，移除 POST 參數來繞過安全檢查。
>其次，再說一遍，不是所有攻擊都基於 HTML 頁面。 API 
>終端始終是一個潛在的漏洞區域，所以確保你考慮並測試了它們。

---

## **2. 星巴克競態條件**

```
難度：中

URL：Starbucks.com
報告鏈接：http://sakurity.com/blog/2015/05/21/starbucks.html
報告日期：2015.5.21

獎金：無

```

## **描述**

如果你不熟悉競態條件，本質上它是兩個潛在的進程彼此競爭來完成任務，基於一個廚師場景，它在請求被執行期間變得無效。換句話說，這是一個場景，其中你擁有兩個進程，它們本應該是互斥的，不應該同時完成，但是因為它們幾乎同時執行，它們被允許這麼做了。
這裡是一個例子：

1. 你在手機上登錄進了你的銀行站點，並請求將 $500 從你的一個僅僅擁有 $500 的帳戶轉到另一個帳戶。

<p>

2. 這個請求花費很長時間（但是仍然處理），所以你在你的筆記本上登錄，並且再次執行了相同請求。

<p>

3. 筆記本的請求幾乎立即完成了，但是你的手機也是這樣。

<p>

4. 你刷新了銀行帳戶，並發現你的帳戶裡有 $1000。這意味著請求執行了兩次，這本不應被允許，因為你一開始只擁有 $500。

雖然這個很基礎，理念都是一樣的，一些條件存在於請求開始，在完成時，並不存在了。
<p>
所以，回到這個例子，Egor 測試了從一個星巴克的卡中轉帳，並且發現他成功觸發了競態條件。請求使用 CURL 程式幾乎同時創建。

>重要結論
>
>競態條件 是個有趣的攻擊向量，它有時存在於應用處理一些類型的餘額的地方，
>例如金額、積分，以及其他。發現這些漏洞並不總是發生在第一次嘗試的時候，
>並且可能需要執行多次重複同時的請求。這裡，Egor 在成功之前執行了 
>6 次請求。但是要記住在測試它的時候，要注意流量負荷，避免使用連續的測試請求危害到站點。

---

## **3. Binary.com 權限提升**

```
難度：低

URL：binary.com

報告鏈接：https://hackerone.com/reports/98247
報告日期：2015.11.14
獎金：$300
```

## **描述**

這真是一個直接的漏洞，不需要過多解析。
<P>

本質上，在這個場景下，用戶能夠登錄任何帳戶，代表被黑的用戶帳戶，並查看敏感資訊，或執行操作，並且一切只需要知道用戶的 UID。

<p>

在你滲透之前，如果你登錄了`Binary.com/cashier`，並查看了頁面的 HTML，你會注意到有個`<iframe>`標籤包含 PIN 參數。這個參數實際上就是你的帳戶 ID。

<p>
下面，如果你編輯了 HTML，並且插入了另一個 PIN，站點就會自動在新帳戶上執行操作，而不驗證密碼或者任何其他憑據。換句話說，站點會將你看做你所提供的帳戶的擁有者。

<p>

同樣，所需的一切就是知道某人的帳戶號碼。你甚至可以在出現在`iframe`中的時間修改為`PAYOUT`，來觸發另一個帳戶的付款操作。但是，`Bianry.com`表示，所有取款都需要手動人工複查，但是這並不是說，這就一定會被發現。


>重要結論
>
>如果你尋找基於漏洞的認證，要留意憑據傳遞給站點的地方。雖然這個漏洞通過查看頁面原始碼來實現，
>你也可以在使用代理攔截器的時候，留意傳遞的資訊。
>
>如果你的確發現了被傳遞的一些類型的憑據，但他們看起來沒有加密時，要注意了，並且嘗試玩玩它們。
>這裡，PIN 是`CRXXXXXX`而密碼是`0e552ae717a1d08cb134f132`。顯然 PIN 
>沒有解密，但是密碼加密了。未加密的值是一個非常好的地方，你可以從這裡下手。


### **4. HackerOne 信號操作**

```
難度：低

URL：hackerone.com/reports/XXXXX
報告鏈接：https://hackerone.com/reports/106305
報告日期：2015.12.21
獎金：$500
```

## **描述：**

在 2015 年年末，HackerOne 向站點進入了新的功能，叫做信號。
本質上，在這些報告關閉之後，它有助於識別黑客的之前漏洞報告的有效性。重要的是要注意，用戶可以關閉它們在 HackerOne 上的報告，這本應該對他們的聲譽和信號功能毫無影響。
<p>

所以，你可以猜到，在測試該功能的時候，一個黑客發現了這個功能的不合理實現，並且允許黑客向任何團隊創建報告，自己關閉報告，並從中受益。
<p>

>重要結論
>
>通過一個簡短的描述，這裡的結論不可能全部覆蓋。一定要留意新的功能！當站點實現了新的功能時，它對於黑客就像鮮肉一樣。新的功能
>展示了測試新程式碼和搜索漏洞的機會。這就和 Shopify 和 Twitter 的 CSRF，以及 Facebook 的 XSS 漏洞一樣。為了最大利用它們，
>使你自己熟悉公司，並且訂閱公司的博客是個好主意，以便你在一些東西發布之後能夠收到提醒。之後測試它們。

---

## **5. Shopify S3 Bucket 開放**

```
難度：中

URL：cdn.shopify.com/assets
報告鏈接：https://hackerone.com/reports/106305
報告日期：2015.11.9
獎金：$1000
```

## **描述：**

Amazon 簡易存儲 S3，是一個服務，允許用戶在 Amazon 的雲服務器上儲存和託管文件。 Shopify 和許多站點都是用 S3 來儲存和託管靜態內容，例如圖片。
<p>

Amazon Web 服務的整個套件，AWS，是非常健壯的，並包含權限管理系統，允許管理員為每個服務定義權限，包含 S3。許可包含創建 S3 Bucket 的功能（Bucket 就像儲存器的文件夾），讀取和寫入 Bucket ，以及其他。
<p>

根據披露，Shopify 沒有合理配置它們的 S3 Bucket 權限，並且無意中允許任何認證過的 AWS 用戶讀取或寫入它們的 Bucket。這顯然是有問題的，因為你至少不希望惡意的黑帽子使用你的 S3 Bucket 來儲存和託管文件。
<p>

不幸的是，這個問題的細節沒有暴露，但是可能使用 AWS CLI 來發現，這是一個工具，允許你和 AWS 服務在你的共領航上交互。雖然你需要一個 AWS 帳戶來做這個事情，創建帳戶實際上也是免費的，因為你不需要任何服務。因此，使用 CLI 你就可以在 AWS 上認證你自己，並且隨後測試是否可以訪問（這也是我發現 HackerOne Bucket 的方式，它在下面列出）。

>重要結論
>
>當你偵查一個潛在的目標時，確保注意到所有不同的工具，包含 Web 
>服務，它們明顯可以使用。每個服務或軟件，OS，以及其他。你可以尋找或發現新的攻擊向量。此外，使你自己熟悉流行的 Web 工具，
>例如 AWS S3，Zendesk，Rails，以及其他是個好主意。許多站點都使用它們。

---

## **6. HackerOne S3 Bucket 開放**

```
難度：中

URL：[REDACTED].s3.amazonaws.com
報告鏈接：https://hackerone.com/reports/128088
報告日期：2016.4.3
獎金：$2500
```

## **描述：**

我們打算講一些有些不同的東西。這是一個漏洞，我實際上發現了他，並且和上面描述的 Shopify 的問題有些不同，所以我打算詳細分享關於我如何發現他的任何事情。
<p>

所以，一開始，上面描述的漏洞就是，一個 Bucket 公開鏈接到了 Shopify。意思是，當你訪問這個想點時，你會看到 AWS 服務的呼叫，所以黑客就知道 Bucket 指向哪裡。但是我並沒有 -- 我使用了一個很酷的腳本和一些工具來發現了 Bucket。
<p>

在 4 月 3 日的周末，我不知道為什麼，但是我決定跳出思維定式，並嘗試攻擊 HackerOne。我一開始就玩了玩它們的站點，並且每次新漏洞發現時，都迫使我自己閱讀資訊披露，想了解為什麼我錯過了它。我想知道他們的 S3 Bucket 是否存在類似 Shopify 的漏洞。我也想知道，黑客如何訪問了 Shopify 的 Bucket。我了解到它是通過 Amazon 命令行工具來訪問的。
<p>

現在，通常我會使自己停下，因為 HackerOne 這個時候不可能還擁有漏洞。但是我突然有一個想法，它來源於我和 Ben Sadeghipour (@Nahamsec) 的訪談，就是不要懷疑自己，或者公司犯錯的可能。
所以我在 Google 上搜索一些細節，並碰到了兩個有意思的頁面：
<p>
	
[There’s a Hole in 1,951 Amazon S3 Buckets](https://community.rapid7.com/community/infosec/blog/2013/03/27/1951-open-s3-buckets)
<p>

[S3 Bucket Finder](https://digi.ninja/projects/bucket_finder.php)

第一個是個有趣的文章，來自 Rapid7，它是個安全公司，這篇文章關於如何發現公開可寫的 S3 Bucket ，並通過模糊測試，或者猜測 Bucket 名稱來實現。
<p>
第二個是個很酷的工具，它接受一個單詞列表，並呼叫 S3 來尋找 Bucket。但是，它沒有自帶列表。在 Rapid7 的文章中有一行關鍵字，“通過一個不同的列表來猜測名稱，列表包含 1000 強公司的名稱，以 .com, -backup, -media 排列。"
<p>
這就很有意思了。我很快為 HackerOne 創建了一列 Bucket 可能名稱，像這樣：


<pre>
hackerone, hackerone.marketing, hackerone.attachments, hackerone.users, hackerone.files
</pre>

這些都不是真正的 Bucket。它們來自於報告。所以我覺得我肯定能夠發現它。我將其留作一個挑戰。
<p>

現在，使用 Ruby 腳本，我開始呼叫那些 Bucket。事情剛開始並不是那麼好，我發現了幾個 Bucket 但是都拒絕訪問。很不幸，所以我先離開，看看 NetFlix。
<p>

但是這個想法還在提醒著我，所以在我睡覺之前，我決定再次使用更多組合來執行腳本。我再次發現了大量的 Bucket，它們看起來是 HackerOne 的，但是所有都拒絕訪問。我意識到，拒絕訪問起碼告訴我它們是存在的。

<p>
我打開了 Ruby 腳本，它在 Buckets呼叫了ls的等價函數。換句話說，我嘗試觀察它們是否公開可讀的。我想知道它，以及它們是否公開可寫的。

<p>

此外，現在 AWS 提供了命令行工具，aws-cli。我知道它，因為我之前用過，所以我在我的 VM 上快速執行`sudo apt-get aws-cli`，並準備好了。

你可以在`docs.aws.amazon.com/cli/latest/userguide/installing.html`上找到這個東西的指南。

現在，命令`awss3help`會打開 S3 的幫助，並列出可用的命令。這些命令之一是`mv`，以`aws s3 mv [FILE] [s3://BUCKET]`的形式，所以我嘗試：

```sh
touch test.txt
aws s3 mv test.txt s3://hackerone.marketing
```

這是第一個Bucket，我從中收到了拒絕訪問，並在呼叫PutObject操作時，我收到了`move failed: ./test.txt to s3://hackerone.marketing/test.txt A client error(Access Denied )。`
<p>

所以嘗試下一個，`aws s3 mv test.txt s3://hackerone.files`，並且成功了。我收到了這個消息，`move: ./test.txt to s3://hackerone.files/test.txt。`

真是神奇！現在我嘗試刪除文件：`aws s3 rm s3://hackerone.files/test.txt`，同樣成功了。

但是現在我還是懷疑自己。我快速登出了 HackerOne 來報告。並且在我鍵入時，我意識到我並沒有實際確認 Bucket 的所有權。 AWS 允許任何人在全局名字空間下創建任何 Bucket。意思是，你，或者讀者都可能實際擁有我在測試的 Bucket。
<p>

我不確定是否應該不驗證就報告。我搜索了 Google 來看看我是否可以找到任何 Bucket 的引用。我沒有找到什麼東西。我離開了電腦，來理清頭緒。我意識到，最壞的事情就是我得到了另一個無效報告，以及貢獻 -5。另一方面，我知道這至少值 $500，基於 Shopify 的漏洞也可能是 $1000。
<p>

我按下了提交，並去睡覺了。當我醒來的時候，HackerOne 回復了恭喜，並說它們已經修復了它和一些其他的存在漏洞的 Bucket。成功了！並且按照它們的條款，當他們授予獎勵的時候，它們會考慮潛在的安全性，包括我沒有發現但存在漏洞的其它 Bucket。

>重要結論
>
>有多個重要結論：
> 1. 不要低估你的能力，以及開發者犯錯的可能性。 HackerOne 是個優秀的團隊，擁有優秀的安全研究員。但是人們都會犯錯。挑戰你的假設吧。
>
> 2. 不要在首次嘗試之後就放棄。當我發現它的時候，瀏覽器每個 Bucket 都不可用，並且我幾乎離開了。但是之後我嘗試寫入文件，它成功了。
>
> 3. 所有的東西都在於只是。如果你知道存在了哪種漏洞，你就知道了要尋找以及測試什麼。讀這本書就是一個良好的開始。
>
> 4. 一個攻擊面要好於站點，它也是公司所使用的的服務。要跳出思維定式。

---

## **7. 繞過 Gitlab 的雙因素認證**

```
難度：中

URL：無
報告鏈接：https://hackerone.com/reports/128085
報告日期：2016.4.3

獎金：無
```

## **描述：**

4 月 3 日，Jobert Abma（HackerOne 的聯合創始人）向 Gitlab 報告稱，在雙因素認證開啟情況下，攻擊者能夠登錄受害者的帳戶，而不需知道受害者的密碼。
<p>

對於那些不熟悉的人，雙因素認證是兩個登錄步驟，通常用戶輸入它們的用戶名和麵，之後站點會發送驗證碼，通常通過電子郵件或者 SMS，用戶需要輸入它來完成登錄過程。
<p>

這裡，Jobert 注意到，在這個過程中，一旦攻擊者輸入了用戶名和密碼，會發送一個 Token 來結束登錄。在提交這個 Token 時，POST 呼叫為：

```
POST /users/sign_in HTTP/1.1
Host: 159.xxx.xxx.xxx ...

----------1881604860
Content-Disposition: form-data; name="user[otp_attempt]"

212421
----------1881604860-
```

如果攻擊者攔截了它並向呼叫新增了用戶名，例如：

```
POST /users/sign_in HTTP/1.1
Host: 159.xxx.xxx.xxx ...

----------1881604860
Content-Disposition: form-data; name="user[otp_attempt]"

212421
----------1881604860
Content-Disposition: form-data; name="user[login]"

john
----------1881604860-
```

攻擊者就能夠登錄進 John 的帳戶，如果`otp_attempt`對 John 可用。換句話說，在兩步認證期間，如果攻擊者新增了`user[login]`參數，它們就能修改被登錄的帳戶。

現在，唯一的麻煩就是攻擊者需要擁有有效的 OTP Token，用於受害者。但是這就是爆破登場的時候了。如果站點管理員沒有實現速率限制，Jobert 就可以對服務器執行重複呼叫來猜測有效的 Token。攻擊成功的可能性取決於向服務器發送請求的傳輸時間，以及 Token 有效時間的長度，但是無論如何，這裡的漏洞都很明顯。


>重要結論
>
>雙因素驗證是個機巧的系統，難以正確實現。當你注意到站點使用了它時，你需要完整測試所有功能，
>包括 Token 的生命週期，嘗試的最大次數，復用過期的 Token，猜測 Token 的可能性，以及其他。

---

## **8. 雅虎 PHP 資訊洩露**

```
難度：中

URL：http://nc10.n9323.mail.ne1.yahoo.com/phpinfo.php

報告鏈接：https://blog.it-securityguard.com/bugbounty-yahoo-phpinfo-php-disclosure-2/

報告日期；2014.10.16

獎金：無
```

描述：

雖然它並沒有巨額獎金，像是其他漏洞那樣（實際上沒有獎金，非常意外），但這是我最喜歡的報告之一，因為它教會了我網絡掃描和自動化的重要性。
<p>

在 2014 年 10 月，Patrik Fehrenbach（你應該從"Hacking Pro Tips Interview#2"中了解了他，很棒的一個傢伙）發現了雅虎的服務器中存在可訪問的`phpinfo()`文件。如果你不熟悉`phpinfo()`，這是一個敏感的命令，它不應該在生產環境能夠訪問，以及公開訪問，因為它洩露了所有類型的服務器資訊。
<p>

現在，你可能想知道 Patrik 如何找到了`http://nc10.n9323.mail.ne1.yahoo.com`，我保證。結果它 PING 了`yahoo.com`，它返回了`98.138.253.109`。之後它將其傳給了 WHOIS，並發現雅虎實際上擁有下面這些東西

<p>

```
NetRange: 98.136.0.0 - 98.139.255.255
CIDR: 98.136.0.0/14
OriginAS:
NetName: A-YAHOO-US9
NetHandle: NET-98-136-0-0-1
Parent: NET-98-0-0-0-0
NetType: Direct Allocation
RegDate: 2007-12-07
Updated: 2012-03-02
Ref: http://whois.arin.net/rest/net/NET-98-136-0-0-1
```


要注意第一行，雅虎擁有大量的 IP 地址，從`98.136.0.0`到`98.139.255.255`，或者`98.136.0.0/14`，
<br>
這是 260000 個獨立 IP 地址。這是大量的潛在目標。
<p>

Patrik 之後寫了個簡單的 bash 腳本來尋找可用的phpinfo文件：

```sh
#!/bin/bash
for ipa in 98.13{6..9}.{0..255}.{0..255}; do
wget -t 1 -T 5 http://${ipa}/phpinfo.php; done &
```
執行了這個，他在隨機的雅虎服務器上發現了它。


>重要結論
>
>在滲透的時候，考慮公司的整個設施，除非他們告訴你這超出範圍了。雖然這個報告沒有得到一分錢的獎金，我知道 Patrik 
>使用了相似的技巧來尋找一些重要的漏洞來獲得獎金。
>
>此外，你會注意到，這裡有 260000 個潛在的地址，他們不可能手動掃描。在執行這一類型的測試時，自動化非常重要，並且是應該使用的東西。

---

## **9. HackerOne Hacktivity 投票**

```
難度：中

URL：https://hackerone.com/hacktivity

報告鏈接：https://hackerone.com/reports/137503

報告日期：2016.5.10

獎金：Swag
```

描述：

雖然嚴格來說，這裡沒有真正的安全漏洞，這個報告是個跳出思維定式的良好示例。
<p>

2016 年 4 月到 5 月的一段時間，HackerOne 為黑客開發了一個新功能，來通過 Hacktivity 
列表給報告投票。要知道功能是否可用，有個簡單的辦法，也有個難的辦法。通過簡單的辦法，
登錄時`/current_user`的 GET 呼叫會包含`hacktivity_voting_enabled:false`。難的辦法有些有趣，
其中存在漏洞，並且這就是我包含這篇報告的原因。

如果你訪問了 hacktivity 並且查看了頁面源碼，你會注意到非常稀疏，只是一些`div`，沒有真正的內容。

![1](https://raw.githubusercontent.com/dyeat/Document_read/master/Web_Hacking_101/image/9-1.jpg)

HackerOne Hacktivity 頁面源碼
<p>

現在，如果你不喜歡他們的平台，並且沒有安裝類似於 wappalyzer 的插件，僅僅看這個頁面源碼也會告訴你，內容由 JavaScript 渲染。
<p>

所以，知道了之後，如果你打開Chrome 或Firefox 的開發者工具，你可以檢查JavaScript 源碼（在Chrome 中，你需要訪問source，左邊是top>hackerone.com->assets->frontend-XXX.js） 。 Chrome 的開發者工具自帶了花括號美化打印的按鈕，這會使最小化的 JavaScript 刻度。你也可以使用 Burp 來查看返回這個 JavaScript 文件的響應。
<p>

原因是這樣，如果你在 JavaScript 中搜索 POST，你會發現一些 HackerOne 所使用的 路徑，它們可能不是那麼明顯，取決於你的權限，以及內容裡有什麼東西。其中之一是：
<p>

![2](https://raw.githubusercontent.com/dyeat/Document_read/master/Web_Hacking_101/image/9-2.jpg)


HackerOne 應用的 JavaScript POST 投票

你可以看到，我們有兩個用於投票功能的路徑。在寫這個報告的時候，你實際可以執行這些呼叫，並給報告投票。
<p>

現在，這是發現功能的一種方式 -- 在報告中，黑客使用了另一種，通過攔截 HackerOne 的響應（大概是使用類似 Burp 的工具）。它們將返回為假的屬性切換為真。這之後暴露了投票元素，在點擊時，執行了可用的 POST 或者 DELETE 呼叫。
<p>

我想你展示 JavaScript 的原因時，和 JSON 響應交互可能不會總是暴露新的 HTML 元素。因此，瀏覽 JavaScript 可能暴露其它"隱藏的"終端來交互。

>重要結論
>
>JavaScript 程式碼想你提供了來自目標的實際程式碼，你可以瀏覽它們。這非常棒，因為你的測試從完全黑盒，
>對後端沒有任何想法，變成了白盒（雖然也不完全是），其中可以觀察程式碼如何執行。這不意味你需要走查每一行程式碼，
>這裡的 POST 呼叫在 20570 >行發現，只使用了一個簡單的 POST 搜索。

---
## **10. Pronhub Mamcache 未授權訪問**

```
難度：中

URL：stage.pornhub.com

報告鏈接：https://hackerone.com/reports/119871

報告日期：2016.3.1

獎金：$2500

```

描述：

在它們公開啟動之前，Pornhub 在 HackerOne 上開啟了一個私有漏洞獎勵計劃，`*.pornhub.com`域，帶有豐富的獎金，這對於多數黑客來說意思是所有 Pronhub 的子域都是一樣的。現在的問題是發現他們。

在他的博文中，Andy Gill（@ZephrFish）解釋了為什麼這個非常好，它使用超過一百萬潛在名稱的列表，通過測試不同子域名稱是否存在，發現了越 90 個可能的漏洞目標。

現在，如果訪問所有這些站點來觀察什麼是可用的，這會花費大量時間，所以它使用Eyewitness 工具自動化了這個流程（在工具一章中包含），它從有效HTTP/HTTPS 頁面中截了一些截圖，並提供了一個不錯的報告，其中站點監聽80、443、8080 和8443 端口（常見HTTP 和HTTPS 端口）。

根據他的 WriteUp，Andy 稍微切換了一些另見，並使用 Nmap 工具來深入挖掘`stage.pornhub.com`子域。當我問他原因時，它解釋道，以他的經驗，`stage`和開發服務器比起生產服務器更可能擁有錯誤配置的安全權限。所以，一開始，它使用了`nslookup`命令，得到了子域的 IP。


```
nslookup stage.pornhub.com
Server: 8.8.8.8
Address: 8.8.8.8#53
Non-authoritative answer:
Name: stage.pornhub.com
Address: 31.192.117.70
```

我也看到，這個可以通過命令`ping`來完成，但是無論哪種方法，它現在擁有了子域的IP 地址，
<p>
	
並使用命令`sudo namp -sSV -p- 31.192.117.70 -oA stage__ph -T4 &`，它得到了：

```
Starting Nmap 6.47 ( http://nmap.org ) at 2016-06-07 14:09 CEST
Nmap scan report for 31.192.117.70
Host is up (0.017s latency).
Not shown: 65532 closed ports
PORT STATE SERVICE VERSION
80/tcp open http nginx
443/tcp open http nginx
60893/tcp open memcache
Service detection performed.Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 22.73 seconds
```

將命令拆解一下：

- 標誌`-sSV`定義了發送給服務器的封包類型，告訴 Nmap 嘗試和判斷任何開放端口上的服務。
<p>

- `-p-`告訴服務器要檢查所有 65535 個端口（默認只會檢查常用的 1000 個端口）。
<p>

- `31.192.117.70`是要掃描的 IP。
<p>

- `-oA stage__ph`告訴 Nmap 一次以三種主要格式輸出它的發現，使用文件名稱`stage__ph`。
<p>

- `-T4`定義了任務的時間（選項為 0 ~ 5，數字越大就越快）。

對於結果來說，要注意的關鍵就是端口 60893 是打開的，而且 Nmap 認為它運行 Memcache。對於那些不熟悉的人，Memcache 是一個緩存服務，它使用鍵值對來儲存任意資料。它通常通過更快地服務內容，用於提升網站的速度。類似的服務的 Redis。
<p>
發現這本身不是個漏洞，但是是個危險信號（雖然安裝指南推薦使其不可能公開訪問，作為一個安全措施）。測試之後，意外的是 Pornhub 並沒有開啟任何安全手段。 Andy 能夠通過 netcat 連接服務，不需要用戶名和密碼。連接之後，它執行命令來獲取版本，狀態，以及其他，為了確認這個和漏洞。
<p>
但是，惡意攻擊者可以將其用於：

- 造成拒絕服務，通過持續寫入和刪除緩存，因此使服務器保持繁忙（取決於站點的配置）。
<p>

- 通過用垃圾緩存資料填充服務，造成 DOS，同樣取決於站點配置。
<p>

- 執行跨站腳本攻擊，通過注入惡意 JS 載荷作為有效的緩存資料，來提供給用戶。
<p>

- 可能的話，執行 SQL 注入，如果 memcache 資料在資料庫中存儲的話。

>總要結論
>
>子域和更寬泛的網絡配置代表了用於滲透的極大潛能。如果你注意到程序在域中包含`*.SITE.com`
>嘗試找到可能存在漏洞的子域，而不要去追求主站上的低懸的果實，因為人人都能搜索到它們。你也的值花費時間來使你自己熟悉一些工具，
>例如 Nmap、Eyewitness、KnockPy，以及其他。這有助於你獲得 Andy 的視角。

## **總結**
應用邏輯漏洞不一定總是涉及程式碼。反之，利用它們通產更需要敏銳的觀察力，以及跳出思維定式。始終留意其它站點可能使用的工具和服務，因為它們代表了新的攻擊向量。這包括站點所使用的來渲染內容的 JavaScript 庫。
<p>
發現它們或多或少都需要代理攔截器，在將其發送到你所利用的站點之前，它能讓你玩轉一些值。嘗試修改任何值，只要它們和識別你的賬戶相關。這可能包含建立兩個不同的賬戶，以便你有兩套有效的憑據，這可能有幫助。同時尋找隱藏或不常用的終端，它可以用於利用無意中訪問的功能。
<p>

任何時候一些類型的事務發生時，你也應該留意。始終有一些機會，其中開發者沒有在資料庫級別處理競態條件（特別是 NoSQL）。也就是說，它們的程式碼可能會阻止你，但是如果你讓程式碼執行夠快，比如幾乎同時完成，你就能發現靜態條件。確保你多次測試了這個領域內的任何東西，因為每次嘗試不一定都發生，就像星巴克的案例那樣。
<p>

最後，要留意新的功能 -- 它通常為測試展示了新的區域。並且如果可能的話，自動化你的測試來更好利用你的時間。